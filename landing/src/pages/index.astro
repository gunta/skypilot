---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Hero from '../components/Hero.astro';
import ValueProps from '../components/ValueProps.astro';
import Features from '../components/Features.astro';
import CostCalculator from '../components/CostCalculator';
import Installation from '../components/Installation.astro';
import ComingSoon from '../components/ComingSoon.astro';
import FAQ from '../components/FAQ.astro';
import FinalCTA from '../components/FinalCTA.astro';
import Footer from '../components/Footer.astro';
import DitherBackground from '../components/DitherBackground';
import { detectLanguage, type Language } from '../i18n/translations';

// For static GitHub Pages deployment, we default to English
// The client-side script will handle language detection and switching

// Get the language from URL parameter
const urlSearchParams = new URLSearchParams(Astro.url.search);
const langParam = urlSearchParams.get('lang') as Language | null;

// Debug logging
console.log('[index.astro] Full URL:', Astro.url.toString());
console.log('[index.astro] URL search:', Astro.url.search);
console.log('[index.astro] URL pathname:', Astro.url.pathname);
console.log('[index.astro] Language param from URL:', langParam);
console.log('[index.astro] All search params:', Array.from(urlSearchParams.entries()));

// Use URL parameter if provided, otherwise default to English
// Client-side script will handle auto-detection and redirect
const lang: Language = (langParam === 'ja' || langParam === 'en') ? langParam : 'en';

console.log('[index.astro] Final language used:', lang);

const title = lang === 'ja' 
  ? 'Sky Pilot - 安全な Sora 2 CLI & ダッシュボード | オープンソース動画生成ツール'
  : 'Sky Pilot - Secure Sora 2 CLI & Dashboard | Open Source Video Generation Tool';

const description = lang === 'ja'
  ? '無料でオープンソースの OpenAI Sora 2 動画 API 用 CLI と TUI。完全にあなたのマシン上で実行—サーバーコスト不要、最高のプライバシー。150 以上の通貨でコストを追跡。'
  : 'Free, open-source CLI and TUI for OpenAI\'s Sora 2 video API. Runs entirely on your machine—no server costs, maximum privacy. Track costs in 150+ currencies.';
---

<BaseLayout title={title} description={description} lang={lang}>
  <DitherBackground client:load />
  <Navigation lang={lang} />
  <Hero lang={lang} />
  <ValueProps lang={lang} />
  <Features lang={lang} />
  
  <section class="section-container bg-bg-secondary/80 backdrop-blur-sm">
    <CostCalculator client:load lang={lang} />
  </section>
  
  <Installation lang={lang} />
  <ComingSoon lang={lang} />
  <FAQ lang={lang} />
  <FinalCTA lang={lang} />
  <Footer lang={lang} />
  
  <!-- Language detection and switching for static GitHub Pages -->
  <script is:inline>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const langParam = urlParams.get('lang');
      
      if (langParam && (langParam === 'en' || langParam === 'ja')) {
        // Valid language parameter exists - store it
        localStorage.setItem('preferred-language', langParam);
      } else {
        // No language parameter in URL - check for stored preference or detect
        const storedLang = localStorage.getItem('preferred-language');
        
        if (storedLang && (storedLang === 'en' || storedLang === 'ja')) {
          // Use stored preference
          const newUrl = new URL(window.location.href);
          newUrl.searchParams.set('lang', storedLang);
          window.location.replace(newUrl.toString());
        } else {
          // First visit - detect from browser
          const browserLang = navigator.language.toLowerCase();
          const detectedLang = browserLang.startsWith('ja') ? 'ja' : 'en';
          localStorage.setItem('preferred-language', detectedLang);
          
          const newUrl = new URL(window.location.href);
          newUrl.searchParams.set('lang', detectedLang);
          window.location.replace(newUrl.toString());
        }
      }
    })();
  </script>
</BaseLayout>

